<script>
    const chatBox = document.getElementById('chat-box');
    const inputForm = document.getElementById('input-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    // The GitHub Action will replace this placeholder.
    const BACKEND_URL = '__BACKEND_URL__';

    inputForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const userMessage = messageInput.value.trim();

        if (!userMessage) return;

        addMessage(userMessage, 'user-message');
        messageInput.value = '';
        toggleLoading(true);

        try {
            // --- THIS IS THE MODIFIED PART ---
            // 1. Add a unique timestamp to the URL to prevent caching.
            const urlWithCacheBust = `${BACKEND_URL}?t=${new Date().getTime()}`;

            const response = await fetch(urlWithCacheBust, {
                method: 'POST',
                // 2. Change Content-Type to 'text/plain' to avoid preflight.
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ message: userMessage })
            });
            // --- END OF MODIFICATION ---


            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            addMessage(data.reply, 'ai-message');

        } catch (error) {
            console.error('Error:', error);
            // Check if error is a TypeError, which often indicates a network/CORS failure.
            const displayError = error instanceof TypeError ?
                "Could not connect to the server. Please check the connection and try again." :
                error.message;
            addMessage(`Error: ${displayError}`, 'ai-message');
        } finally {
            toggleLoading(false);
        }
    });

    function addMessage(text, className) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', className);
        messageElement.textContent = text;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function toggleLoading(isLoading) {
        sendButton.disabled = isLoading;
        let loadingIndicator = document.querySelector('.loading-indicator');
        if (isLoading && !loadingIndicator) {
            loadingIndicator = document.createElement('div');
            loadingIndicator.classList.add('message', 'loading-indicator');
            loadingIndicator.textContent = 'Assistant is typing...';
            chatBox.appendChild(loadingIndicator);
            chatBox.scrollTop = chatBox.scrollHeight;
        } else if (!isLoading && loadingIndicator) {
            loadingIndicator.remove();
        }
    }
</script>